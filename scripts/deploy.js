var web3_lib = require('web3')
var tx_lib = require('ethereumjs-tx').Transaction
var web3 = new web3_lib('HTTP://127.0.0.1:7545')

const creator_public_key = '0x211a2C2a94265F8c79b1d0a3b8540eF5F58e23aB'
const creator_private_key = Buffer.from('ec7f24df2781b3f70cd46a0d91ab3cca61fad20b13255f7c828454a987996f65', 'hex')

web3.eth.getTransactionCount(creator_public_key, (err, txCount) => {
    const byte_code = '0x6080604052600067ffffffffffffffff8111801561001c57600080fd5b5060405190808252806020026020018201604052801561004b5781602001602082028036833780820191505090505b5060029080519060200190610061929190610294565b50600067ffffffffffffffff8111801561007a57600080fd5b506040519080825280602002602001820160405280156100a95781602001602082028036833780820191505090505b50600390805190602001906100bf92919061031e565b503480156100cc57600080fd5b506040516109a63803806109a6833981810160405260208110156100ef57600080fd5b810190808051906020019092919050505080600181905550336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167f342827c97908e5e2f71151c08502a66d44b6f758e3ac2f1de95f02eb95f0a73560405160405180910390a360008090505b60015481101561028d5760026000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600381908060018154018082558091505060019003906000526020600020016000909190919091505580806001019150506101c9565b50506103d3565b82805482825590600052602060002090810192821561030d579160200282015b8281111561030c5782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550916020019190600101906102b4565b5b50905061031a919061036b565b5090565b82805482825590600052602060002090810192821561035a579160200282015b8281111561035957825182559160200191906001019061033e565b5b50905061036791906103ae565b5090565b6103ab91905b808211156103a757600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905550600101610371565b5090565b90565b6103d091905b808211156103cc5760008160009055506001016103b4565b5090565b90565b6105c4806103e26000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c80630ca018a31461006757806335942eda146100ab578063893d20e8146100ef578063949d225d14610139578063d79fa15114610157578063efad193614610199575b600080fd5b6100a96004803603602081101561007d57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610207565b005b6100ed600480360360208110156100c157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061033a565b005b6100f7610502565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61014161052b565b6040518082815260200191505060405180910390f35b6101836004803603602081101561016d57600080fd5b8101908080359060200190929190505050610531565b6040518082815260200191505060405180910390f35b6101c5600480360360208110156101af57600080fd5b8101908080359060200190929190505050610552565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000600380549050141561025e57600073ffffffffffffffffffffffffffffffffffffffff167f2560ff27b146ab24f00cbb6dc725b080a2cd8199898b428638d346cbe907f55460405160405180910390a2610337565b6000600360008154811061026e57fe5b90600052602060002001549050816002828154811061028957fe5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060038054806102dc57fe5b600190038181906000526020600020016000905590558173ffffffffffffffffffffffffffffffffffffffff167f2560ff27b146ab24f00cbb6dc725b080a2cd8199898b428638d346cbe907f55460405160405180910390a2505b50565b600080905060008090505b6001548110156104b3578273ffffffffffffffffffffffffffffffffffffffff166002828154811061037357fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156104a657600191508273ffffffffffffffffffffffffffffffffffffffff167f25eea1058d889fb97345d8be34d09e3c19b4f670e0886675e139afb602df331460405160405180910390a26000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff166002828154811061043057fe5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060038190806001815401808255809150506001900390600052602060002001600090919091909150556104b3565b8080600101915050610345565b50806104fe57600073ffffffffffffffffffffffffffffffffffffffff167f25eea1058d889fb97345d8be34d09e3c19b4f670e0886675e139afb602df331460405160405180910390a25b5050565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60015481565b6003818154811061053e57fe5b906000526020600020016000915090505481565b6002818154811061055f57fe5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff168156fea26469706673582212209ead3f45537a8180d824debc0ee6e0269ff670c27b8d2f19259b96d9917fff1364736f6c63430006060033'
    const gasPrice = 20000000000
    var txData = {
        nonce : web3.utils.toHex(txCount),
        gasLimit : web3.utils.toHex(100000),
        gasPrice : web3.utils.toHex(gasPrice),
        data : byte_code
    }

    const txObj = new tx_lib(txData)
    txObj.sign(creator_private_key)

    const serialized = txObj.serialize().toString('hex')
    const raw = '0x' + serialized
    console.log('ABOUT TO SEND TRANSACTION')
    web3.eth.sendSignedTransaction(raw, (err, txHash) => {console.log('err:', err, 'txHash:', txHash)})
})

// var gasPrice = 0
// var cb = (err, val) => { gasPrice = val }
// web3.eth.getGasPrice(cb)
// console.log('gasPrice:', gasPrice)
